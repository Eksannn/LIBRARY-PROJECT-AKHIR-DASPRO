#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>

#ifdef _WIN32
  #define STRCASECMP _stricmp
#else
  #define STRCASECMP strcasecmp
#endif

#define MAX_BOOK 600
#define MAX_NAME 200
#define MAX_LOAN 600

/* FILES */
const char *F_BUKU = "buku.txt";
const char *F_LOAN = "data_pinjam.txt";
const char *F_HIST = "history.txt";

/* STRUKTUR BUKU */
typedef struct {
    int id;
    char judul[MAX_NAME];
    char jenis[50];
    int stok;
} Buku;

/* STRUKTUR PINJAMAN */
typedef struct {
    char user[50];
    int idBuku;
    long long pinjam_ts;
    long long due_ts;
} Pinjam;

/* ARRAY MEMORY */
Buku buku[MAX_BOOK];
int jumlahBuku = 0;

Pinjam loan[MAX_LOAN];
int jumlahLoan = 0;

/* LOADER DATASET */

void loadBuku() {
    FILE *fp = fopen(F_BUKU, "r");
    if (!fp) {
        printf("File buku.txt tidak ditemukan!\n");
        exit(1);
    }

    jumlahBuku = 0;

    char line[512];
    while (fgets(line, sizeof(line), fp)) {
        if (strlen(line) < 5) continue;

        int id, stok;
        char judul[200], jenis[50];

        if (sscanf(line, "%d;%199[^;];%49[^;];%d",
                   &id, judul, jenis, &stok) == 4)
        {
            buku[jumlahBuku].id = id;
            strcpy(buku[jumlahBuku].judul, judul);
            strcpy(buku[jumlahBuku].jenis, jenis);
            buku[jumlahBuku].stok = stok;
            jumlahBuku++;
        }
    }

    fclose(fp);
}

/*  SAVE DATASET  */

void saveBuku() {
    FILE *fp = fopen(F_BUKU, "w");
    if (!fp) return;

    for (int i = 0; i < jumlahBuku; i++) {
        fprintf(fp, "%d;%s;%s;%d\n",
                buku[i].id,
                buku[i].judul,
                buku[i].jenis,
                buku[i].stok);
    }

    fclose(fp);
}

/*  LOADER PINJAMAN  */

void loadLoan() {
    FILE *fp = fopen(F_LOAN, "r");
    if (!fp) return;

    jumlahLoan = 0;

    char line[256];
    while (fgets(line, sizeof(line), fp)) {
        char user[50];
        int id;
        long long ts, due;

        if (sscanf(line, "%49[^;];%d;%lld;%lld",
                   user, &id, &ts, &due) == 4)
        {
            strcpy(loan[jumlahLoan].user, user);
            loan[jumlahLoan].idBuku = id;
            loan[jumlahLoan].pinjam_ts = ts;
            loan[jumlahLoan].due_ts = due;
            jumlahLoan++;
        }
    }

    fclose(fp);
}

/*  SAVE PINJAMAN  */

void saveLoan() {
    FILE *fp = fopen(F_LOAN, "w");
    if (!fp) return;

    for (int i = 0; i < jumlahLoan; i++) {
        fprintf(fp, "%s;%d;%lld;%lld\n",
                loan[i].user,
                loan[i].idBuku,
                loan[i].pinjam_ts,
                loan[i].due_ts);
    }

    fclose(fp);
}

/*  HISTORY  */

void historyWrite(const char *aksi, const char *user, const char *judul) {
    FILE *fp = fopen(F_HIST, "a");
    if (!fp) return;

    time_t t = time(NULL);
    fprintf(fp, "%s | %s | %s | %s\n",
            aksi, user, judul, ctime(&t));

    fclose(fp);
}
/* MENAMPILKAN PINJAMAN USER */
void cekPinjamanUser(const char *username) { 
    printf("\n=== Daftar Pinjaman Anda ===\n");

    int found = 0;
    for (int i = 0; i < jumlahLoan; i++) {
        if (STRCASECMP(loan[i].user, username) == 0) {
            int idxB = cariBukuByID(loan[i].idBuku);
            if (idxB != -1) {
                printf("ID:%d | Buku: %s | Deadline: %s",
                       loan[i].idBuku,
                       buku[idxB].judul,
                       ctime(&loan[i].due_ts));
                found = 1;
            }
        }
    }

    if (!found)
        printf("(Tidak ada pinjaman)\n");
}

/* ================================================================
   PINJAM BUKU
   ================================================================ */
void pinjamBuku(const char *username) {
    char jenisList[20][50];
    int totalJenis = listJenis(jenisList);

    printf("\nPilih jenis buku: ");
    int pilihJenis;
    scanf("%d", &pilihJenis);

    if (pilihJenis < 1 || pilihJenis > totalJenis) {
        printf("Pilihan tidak valid!\n");
        return;
    }

    const char *jenisDipilih = jenisList[pilihJenis - 1];

    int indexOut[600];
    int total = listBukuByJenis(jenisDipilih, indexOut, 600);

    if (total == 0) return;

    printf("\nMasukkan ID buku yang ingin dipinjam: ");
    int id;
    scanf("%d", &id);

    int idx = cariBukuByID(id);
    if (idx == -1) {
        printf("Buku tidak ditemukan!\n");
        return;
    }

    if (buku[idx].stok <= 0) {
        printf("Stok habis!\n");
        return;
    }

    /* Kurangi stok */
    buku[idx].stok--;
    saveBuku();

    /* Catat waktu */
    time_t now = time(NULL);
    time_t due = now + (7 * 24 * 3600); // 7 hari

    /* Simpan ke loan */
    strcpy(loan[jumlahLoan].user, username);
    loan[jumlahLoan].idBuku = id;
    loan[jumlahLoan].pinjam_ts = now;
    loan[jumlahLoan].due_ts = due;
    jumlahLoan++;
    saveLoan();

    /* History */
    historyWrite("PINJAM", username, buku[idx].judul);

    printf("\nPeminjaman berhasil!\n");
    printf("Judul: %s\n", buku[idx].judul);
    printf("Deadline pengembalian: %s\n", ctime(&due));
}

/* ================================================================
   PENGEMBALIAN
   ================================================================ */
void kembalikanBuku(const char *username) {
    printf("\n=== Pengembalian Buku ===\n");

    int daftarPinjaman[600];
    int counter = 0;

    for (int i = 0; i < jumlahLoan; i++) {
        if (STRCASECMP(loan[i].user, username) == 0) {
            int idxB = cariBukuByID(loan[i].idBuku);
            if (idxB != -1) {
                printf("%d. ID:%d | %s\n",
                       counter + 1,
                       loan[i].idBuku,
                       buku[idxB].judul);

                daftarPinjaman[counter] = i;
                counter++;
            }
        }
    }

    if (counter == 0) {
        printf("Anda tidak memiliki pinjaman.\n");
        return;
    }

    printf("\nPilih nomor buku yang ingin dikembalikan: ");
    int pilih;
    scanf("%d", &pilih);

    if (pilih < 1 || pilih > counter) {
        printf("Pilihan salah!\n");
        return;
    }

    int idxLoan = daftarPinjaman[pilih - 1];
    int idBuku = loan[idxLoan].idBuku;
    int idxBuku = cariBukuByID(idBuku);

    /* Tambahkan stok */
    buku[idxBuku].stok++;
    saveBuku();

    /* Catat history */
    historyWrite("KEMBALI", username, buku[idxBuku].judul);

    /* Hapus data pinjaman */
    for (int i = idxLoan; i < jumlahLoan - 1; i++)
        loan[i] = loan[i + 1];

    jumlahLoan--;
    saveLoan();

    printf("\nPengembalian berhasil!\n");
    printf("Buku: %s\n", buku[idxBuku].judul);
}
